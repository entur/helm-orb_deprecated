# THIS FILE IS AUTOGENERATED AFTER GIT COMMIT. CHANGES TO THIS FILE WILL BE DISCARDED. #
commands:
  install-helm-chart:
    description: |
      Installs a helm chart in Kubernetes.
    parameters:
      chart:
        description: |
          Specify for installation a chart reference (e.g. helm/mychart),
          or a path to a packaged chart (e.g. ./mychart-1.2.3.tgz),
          or a path to an unpacked chart directory (e.g. ./helm)
          or an absolute URL (e.g. https://example.com/charts/mychart-1.2.3.tgz)
        type: string
      namespace:
        default: ""
        description: |
          The kubernetes namespace that should be used.
          Examples: dev, staging, production, kafka
        type: string
      release-name:
        default: ""
        description: |
          Specify a name for the release.
        type: string
      wait:
        default: true
        description: |
          Whether to wait for the installation to be complete. Default true
        type: boolean
    steps:
    - install-helm-client
    - run:
        command: |-
          NAMESPACE="<< parameters.namespace >>"
          WAIT="<< parameters.wait >>"
          if [ -n "${NAMESPACE}" ]; then
            set -- "$@" --namespace="${NAMESPACE}"
            set -- "$@" --set environment="${NAMESPACE}"
          fi
          if [ "${WAIT}" == "true" ]; then
            set -- "$@" --wait
          fi
          helm upgrade --install << parameters.release-name >> << parameters.chart >> "$@"
        name: Deploy Helm chart to Kubernetes
  install-helm-client:
    description: |
      Install the helm client.

      Helm version: helm-v2.13.1-linux-amd64
      Download from: (https://storage.googleapis.com/kubernetes-helm/helm-v2.13.1-linux-amd64.tar.gz)
      Requirements: curl
    steps:
    - run:
        command: |-
          if which helm > /dev/null; then
            echo "Helm is already installed.. skipping install"
            exit 0
          fi
          HELM_VER="helm-v2.13.1-linux-amd64"
          curl -L -o /tmp/$HELM_VER.tar.gz https://storage.googleapis.com/kubernetes-helm/$HELM_VER.tar.gz
          tar -zxv -C /tmp -f /tmp/$HELM_VER.tar.gz
          mv /tmp/linux-amd64/helm /usr/local/bin/helm
          helm init --client-only
        name: Install and init the helm client
description: |-
  An orb for working with helm for kubernetes deployments in Google Cloud Platform.
  Made for Entur AS.
  Project homepage: https://github.com/entur/helm-orb
version: 2.1

