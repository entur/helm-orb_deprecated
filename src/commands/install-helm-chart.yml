description: |
  Installs a helm chart in Kubernetes.

parameters:
  chart:
    description: |
      Specify for installation a chart reference (e.g. helm/mychart),
      or a path to a packaged chart (e.g. ./mychart-1.2.3.tgz),
      or a path to an unpacked chart directory (e.g. ./helm)
      or an absolute URL (e.g. https://example.com/charts/mychart-1.2.3.tgz)
    type: string
  release-name:
    description: |
      Specify a name for the release.
    type: string
    default: ""
  namespace:
    description: |
      The kubernetes namespace that should be used.
      Examples: dev, staging, production, kafka
    type: string
    default: ""
  wait:
    description: |
      Whether to wait for the installation to be complete. Default true
    type: boolean
    default: true

steps:
  - authenticate-gcp
  - install-helm-client
  - run:
      name: Deploy Helm chart to Kubernetes
      command: |
        NAMESPACE="<< parameters.namespace >>"
        WAIT="<< parameters.wait >>"
        if [ -n "${NAMESPACE}" ]; then
          set -- "$@" --namespace="${NAMESPACE}"
          set -- "$@" --set environment="${NAMESPACE}"
        fi
        if [ "${WAIT}" == "true" ]; then
          set -- "$@" --wait
        fi
        helm upgrade --install << parameters.release-name >> << parameters.chart >> "$@"
