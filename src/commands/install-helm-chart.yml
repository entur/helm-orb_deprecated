description: |
  Installs a helm chart in Kubernetes.

parameters:
  chart:
    description: |
      Specify for installation a chart reference (e.g. helm/mychart),
      or a path to a packaged chart (e.g. ./mychart-1.2.3.tgz),
      or a path to an unpacked chart directory (e.g. ./helm)
      or an absolute URL (e.g. https://example.com/charts/mychart-1.2.3.tgz)
    type: string
  release-name:
    description: |
      Specify a name for the release.
    type: string
    default: ""
  namespace:
    description: |
      The kubernetes namespace that should be used.
      Examples: dev, staging, production, kafka
    type: string
    default: ""
  wait:
    description: |
      Whether to wait for the installation to be complete. Default true
    type: boolean
    default: true
  gcp-service-key:
    The credentials for the Service Account to be used when communicating to Google Cloud.
    If not provided, the command will look for the environment variable $GCLOUD_SERVICE_KEY

    To obtain the key for this command,
    use either the Google Cloud Platform Console or gcloud iam service-accounts keys create.
    The key can be .json (preferred) or .p12 (legacy) format.
    type: string
    default: ""
  gcp-container-cluster:
    description: |
      The name of the Google Cloud container cluster to use.
      If not provided, the command will look for the environment variable $CLOUDSDK_CONTAINER_CLUSTER

      To obtain the name of your clusters,
      use the Google Cloud Platform Console (Command: gcloud container clusters list)
    type: string
    default: ""

steps:
  - authenticate-gcp:
      gcp-service-key: << parameters.gcp-service-key >>
      gcp-container-cluster: << parameters.gcp-container-cluster >>
  - install-helm-client
  - run:
      name: Deploy Helm chart to Kubernetes
      command: |
        NAMESPACE="<< parameters.namespace >>"
        WAIT="<< parameters.wait >>"
        if [ -n "${NAMESPACE}" ]; then
          set -- "$@" --namespace="${NAMESPACE}"
          set -- "$@" --set environment="${NAMESPACE}"
        fi
        if [ "${WAIT}" == "true" ]; then
          set -- "$@" --wait
        fi
        helm upgrade --install << parameters.release-name >> << parameters.chart >> "$@"
