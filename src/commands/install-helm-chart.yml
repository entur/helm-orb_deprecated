description: |
  Installs a Helm chart in Kubernetes.

parameters:
  chart:
    description: |
      Specify for installation a chart reference (e.g. helm/mychart),
      or a path to a packaged chart (e.g. ./mychart-1.2.3.tgz),
      or a path to an unpacked chart directory (e.g. ./helm)
      or an absolute URL (e.g. https://example.com/charts/mychart-1.2.3.tgz)
    type: string
  release-name:
    description: |
      Specify a name for the release.
    type: string
    default: ""
  namespace:
    description: |
      The kubernetes namespace that should be used.
      Examples: dev, staging, production, kafka
    type: string
    default: ""
  value-files:
    description: |
      Specify values in a YAML file or a URL (can specify multiple).
      Separated by comma ( , )
      (e.g. helm/some-values.yaml, helm/other-values.yaml)
    type: string
    default: ""
  wait:
    description: |
      Whether to wait for the installation to be complete. Default true
    type: boolean
    default: true

  #| ---- Authentication ---- |#
  gcp-service-key:
    description: |
      The credentials for the Service Account to be used when communicating to Google Cloud.
      If not provided, the command will look for the environment variable $GCLOUD_SERVICE_KEY

      To obtain the key for this command,
      use either the Google Cloud Platform Console or gcloud iam service-accounts keys create.
      The key can be .json (preferred) or .p12 (legacy) format.
    type: string
    default: ""
  gcp-container-cluster:
    description: |
      The name of the Google Cloud container cluster to use.
      If not provided, the command will look for the environment variable $CLOUDSDK_CONTAINER_CLUSTER

      To obtain the name of your clusters,
      use the Google Cloud Platform Console (Command: gcloud container clusters list)
    type: string
    default: ""

steps:
  - authenticate-gcp-container-cluster:
      gcp-service-key: << parameters.gcp-service-key >>
      gcp-container-cluster: << parameters.gcp-container-cluster >>
  - install-helm-client
  - run:
      name: Deploy Helm chart to Kubernetes
      command: |
        NAMESPACE="<< parameters.namespace >>"
        VALUE_FILES="<< parameters.value-files >>"
        CHART="<< parameters.chart >>"
        WAIT="<< parameters.wait >>"
        BUCKET_NAME="<< parameters.gcs-bucket-name >>"        
        if [[ -n "${VALUE_FILES}" ]]; then
            SPLIT_VALUE_FILES=($(echo ${VALUE_FILES} | tr "," "\n"))
            for i in ${SPLIT_VALUE_FILES[@]} ; do
                set -- "$@" -f "${i}"
            done
        fi
        if [[ -n "${NAMESPACE}" ]]; then
          set -- "$@" --set environment="${NAMESPACE}"
          set -- "$@" --namespace="${NAMESPACE}"
        fi
        if [[ "${WAIT}" == "true" ]]; then
          set -- "$@" --wait
        fi
        if [[ -f "${CHART}/requirements.yaml" ]]; then
          echo "Initializing ${BUCKET_NAME}."
          helm gcs init gs://${BUCKET_NAME} --service-account ${HOME}/account-auth.json
          echo "Adding ${BUCKET_NAME} as repository."
          export GOOGLE_APPLICATION_CREDENTIALS=${HOME}/account-auth.json
          helm repo add ${BUCKET_NAME} gs://${BUCKET_NAME}
          echo "Updating dependencies"
          cd "${CHART}"
          helm dependency list
          helm dependency update
          helm dependency build
        fi
        helm upgrade << parameters.release-name >> << parameters.chart >> "$@" --install
